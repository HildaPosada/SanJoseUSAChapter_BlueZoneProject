import pandas as pd
from zipfile import BadZipFile

# File paths
data_file_path = 'analytic_data2017.xlsx'
example_file_path = '2024_Example_Data.xlsx'
output_file_path = 'Cleaned_analytic_data2017.xlsx'

try:
    # Load the main data file
    df = pd.read_excel(data_file_path, engine='openpyxl')

    # Load the example file for context on color coding
    example_df = pd.read_excel(example_file_path, engine='openpyxl')

    # Remove the first row
    df.drop(index=df.index[0], inplace=True)

    # Remove the third row with 'US' as the county
    df = df[df.iloc[:, 0] != 'US']

    # Set the header row (v_ codes) as the actual header
    df.columns = df.iloc[0]
    df = df[1:]

    # Remove columns containing "CI high", "CI low", "Numerator", and "Denominator"
    df = df.loc[:, ~df.columns.str.contains('CI high|CI low|Numerator|Denominator', case=False, na=False)]

    # Identify columns based on the example dataset
    green_columns = example_df.loc[example_df['Color'] == 'Green', 'Column Name'].tolist()
    brown_columns = example_df.loc[example_df['Color'] == 'Brown', 'Column Name'].tolist()
    blue_columns = example_df.loc[example_df['Color'] == 'Blue', 'Column Name'].tolist()

    # Keep only green and blue columns (if present)
    keep_columns = green_columns + blue_columns
    df = df[keep_columns]

    # Save the cleaned DataFrame to a new Excel file
    df.to_excel(output_file_path, index=False, engine='openpyxl')

    print(f"Cleaned file saved as {output_file_path}")

except BadZipFile:
    print("Error: The file appears to be corrupted or is not a valid .xlsx file.")
except FileNotFoundError:
    print("Error: The file was not found. Please check the file path.")
except Exception as e:
    print(f"An unexpected error occurred: {e}")
